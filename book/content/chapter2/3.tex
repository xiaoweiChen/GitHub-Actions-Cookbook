
在此食谱中,我们将添加一个诱使操作,该动作将检查工作流程并直接在拉请请求中提供馈。

\mySubsubsection{2.3.1}{Getting ready}

打开您为打开拉的请求的分支中的工作流文件。不要合并更改。

\mySubsubsection{2.3.2}{How to do it…}

\begin{enumerate}
\item 
去市场并搜索Actionlint。我们正在寻找的动作来自Devops-actions。该操作需要访问工流文件,这意味着您必须先使用结帐操作查看存储库。将以下两个步骤添加到工作结束

\begin{shell}
  - uses: actions/checkout@v4.1.0
  - uses: devops-actions/actionlint@v0.1.2
\end{shell}

\item 
由于我们希望采取行动来注释“拉”请求中的错误,因此我们必须给予工作流写入访以拉动请求。稍后我将解释这是如何工作的。目前,只需在这样的工作中添加部分权限

\begin{shell}
jobs:
  job1:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
\end{shell}

\item 
将更改提交给分支新工作流,然后将它们推到遥控器上。这将触发构建,工作流程应没有错误的情况下完成。

\item 
要测试覆盖过程,我们将添加一些恶意代码。如果您在运行事件中使用用户控制的输,例如拉请请求的标题,则攻击者可能能够通过在标题中注入脚本来利用这一点。如果有一个公共存储库,并且人们可以从叉子中提出拉请请求,这一点尤其重要。假设您使Echo输出拉动请求的标题:

\begin{shell}
  - run: echo "${{ github.event.pull_request.title }}"
\end{shell}

创建带有标题 \verb|"Hi";ls $GITHUB_WORKSPACE;echo "-" | 的拉请请求,将执行以下命令:

\begin{shell}
$ echo "Hi";ls $GITHUB_WORKSPACE;echo "-"
\end{shell}

脚本\verb|ls $ GITHUB_WORKSPACE|将在没有错误的情况下执行,从那里,您可以找到其他方来注入更有害的脚本。

将以下行添加到工作中的步骤:

\begin{shell}
steps:
  - run: echo "PR title is '${{ github.event.pull_request.title
}}'.
\end{shell}

\item 
将更改提交给分支新工作流,然后将它们推到遥控器上。这次,工作流程应该失败, 且拉动请求的检查显示错误,如图2.17:

\myGraphic{0.4}{content/chapter2/images/17.png}{图2.17  ---  如果您的工作流程中存在潜在的脚本攻击，则覆盖可能会失败。}

\item 
在“拉”请求中,导航到文件更改。请注意,伸缩措施已在包含潜在脚本注入攻击的确行号上注释了拉的请求(请参见图2.18):

\myGraphic{0.4}{content/chapter2/images/18.png}{图2.18  ---  工作流文件中的拉请求注释}
\end{enumerate}

\mySubsubsection{2.3.3}{How it works…}

Action DevOps-Actions/ActionLint(\url{https://github.com/marketplace/action/rhysd-actionLint})是rhysd(这是github用户)ActionLint容器的包装器(请参阅\url{https://github.com.com.com/rhysdactionlint})。您可以在本地或网络上运行ActionLint。它有大量检查在工作流程上执行的检(请参阅\url{https://github.com/rhysd/actionlint/blob/blob/main/docs/checks.md},有关完整列)。该动作是一个包装器,可针对存储库中发现的所有工作流程运行动作皮棉。因此, 必须先检查存储库。然后,该操作使用问题匹配器(请参阅\url{https://github.com/actions/toolkit/blob/main/doc/docs/resasure-matchers.md})来注释您的工作流程中的工作流程。问题匹配者使用正则表达式模式从结果文件中读取发现并注释您的拉请求。它们被工作流命令添匹配器和删除匹配器激活和停用。可以使用工作流命令在工作流程步骤和操作中,与工作流和跑步机通信。它们可用于将消息写入工作流日志, 值传递给其他步骤或操作,设置环境变量或编写调试消息。

WorkFlow命令使用ECHO命令具有特定格式:

\begin{shell}
  echo "::workflow-command param1={data},param2={data}::{command value}"
\end{shell}

如果您使用的是JavaScript,则该工具包(\url{https://github.com/actions/toolkit})提供了许多可以用的包装器,而不是使用echo来写入标准输出。在后续部分中,您将学习一些有用的工流命令的示例,以写入工作流日志和注释文件。

使用以下工作流命令添加问题匹配器:

\begin{shell}
  echo "::add-matcher::$GITHUB_ACTION_PATH/actionlint-matcher.json"
\end{shell}

该命令接受结果文件的路径作为参数。您可以通过移除匹配器并传入所有者来禁用匹配功能：remove-matcher。

\begin{shell}
  echo "::remove-matcher owner= actionlint::"
\end{shell}

为了访问拉动请求,工作流使用 GITHUB\_TOKEN,这是一个特殊的令牌,它是由github自动创建,可以通过github上下文(github.token)或秘密上下文(secrets.GITHUB\_TOKEN)访问。即使作流不提供输入或环境变量,也可以通过GitHub操作访问令牌。代币可用于访问GitHub 源时的工作流程。默认权限可以设置为允许(读取和写入)或限制(仅读取),但可以工作流中调整权限。您可以在Set up job | GITHUB\_
TOKEN Permissions下的工作流登录中的工作流权限最好的做法是始终明确设置工作流程的权限。 所有其他权限将自动设置为无。可以为个工作或整个工作流程设置权限。

在我们的情况下，我们授予工作流程许可以阅读内容并写入以拉请求：

\begin{shell}
permissions:
  contents: read
  pull-requests: write
\end{shell}

\mySubsubsection{2.3.4}{There's more…}

在此食谱中,我们只需在工作流程中添加pull\_request触发器即可添加工作流程衬里作为拉的求的检查。但是,即使支票失败,我们仍然可以将更改合并回主分支。为了防止与绒毛误合并的工作流程,您可以启用分支保护(请参见\url{https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/about-protected-branches})或者创建规则集(请参见\url{https://docs.github.com/en/repositories/configuringbranches-and-merges-in-your-repository/managing-rulesets/about-rulesets})。与代码所有者一起(请参阅\url{ https://docs.github.com/en/repositories/managingyour-repositorys-settings-and-features/customizing-your-repository/bout-code-owners}),您可以确保工作流程仅由团队或人返回您的主要分支,而无需仔细检查错误的错误。












