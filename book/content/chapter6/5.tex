这是一个简短的指南,我们将使用它来向现有的 CI 构建中添加 CodeQL 分析。CodeQL 是 GitHub 的代码分析引擎,对于公共存储库它是免费的。

\mySubsubsection{6.5.1}{Getting ready}

在 package-recipe 存储库中创建一个新分支：

\begin{shell}
$ git switch -c add-codeql
\end{shell}

\mySubsubsection{6.5.2}{How to do it…}

\begin{enumerate}
\item 
打开 .github/workflows/ci.yml 文件，并授予构建作业写入安全事件的权限：

\begin{shell}
build:
  permissions:
    pull-requests: write
    security-events: write
\end{shell}

\item 
向作业中添加一个初始化操作(github/codeql-action/init)。对于需要编译的语言，这必须放在构建过程之前。由于 JavaScript 是一种静态语言，您可以将其添加到作业的末尾。将语言设置为 javascript-typescript 并选择 security-and-quality 查询套件：

\begin{shell}
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: 'javascript-typescript'
        queries: security-and-quality
\end{shell}

\item 
实际的分析在编译后执行。只需将以下代码添加到作业的末尾：

\begin{shell}
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript-typescript"
\end{shell}

\item 
提交您的代码，创建一个拉取请求，并在所有检查都通过后合并更改：

\begin{shell}
$ git add .
$ git commit
$ gh pr create --fill
$ gh pr merge -m --auto
\end{shell}
\end{enumerate}

\mySubsubsection{6.5.3}{How it works…}

CodeQL 是 GitHub 的代码分析引擎，用于自动化安全性和质量检查。它在公共存储库中是免费的，并且适用于购买了 GitHub 高级安全许可证的企业。

您可以分析以下语言：

\begin{itemize}
\item 
C/C++

\item 
C\#

\item 
Go

\item 
Java

\item 
Kotlin(在撰写本文时处于测试阶段)

\item 
JavaScript/TypeScript

\item 
Python

\item 
Ruby

\item 
Swift(在撰写本文时处于测试阶段)
\end{itemize}

有三种方法可以分析您的代码：

\begin{itemize}
\item 
默认:CodeQL 的默认设置将自动检测您存储库中的语言并选择受支持的进行分析。它将应用默认的查询套件和扫描触发器。在存储库中,转到Settings | Code security and analysis,,如果您的存储库中的语言受该功能支持,则可以选择Default(见图 6.11):

\myGraphic{0.4}{content/chapter6/images/11.png}{图6.11 --- 使用默认或高级模式配置代码扫描}

\item 
高级：使用自定义工作流程并添加 CodeQL 分析，就像我们在本指南中所做的那样。如果您在设置中点击高级(图 6.11)，这将为您生成一个可定制的工作流程模板。它将使用带有 fail-fast: false 的矩阵策略来分析您存储库中检测到的所有语言。

\item 
命令行界面：直接在外部 CI 系统中运行 CodeQL 命令行界面，并将结果上传到 GitHub。
\end{itemize}

所有工具的分析结果都可以在“安全”|“代码扫描”下访问(见图 6.12)：

\myGraphic{0.4}{content/chapter6/images/12.png}{图6.12 --- 在存储库中查看代码分析结果}

您可以访问报告结果的所有工具的状态。请注意,在我们的存储库中,分析还分析了我们的测试包生成的代码。
要了解更多关于 CodeQL 的信息,请访问:\url{https://docs.github.com/en/code-security/code-scanning/introduction-to-code-scanning/about-code-scanning-with-codeql}。

\mySubsubsection{6.5.4}{There’s more…}

GitHub 支持各种其他工具 - 其中包括 Checkmarx、Snyk、Microsoft Defender for DevOps 和 ESLint。它支持许多商业工具，但也支持许多免费或开源的工具。

如果您在“设置”|“代码安全性和分析”下点击“探索工作流程”(见图 6.13)，然后您将被重定向到一个新的工作流程页面，该页面通过安全类别和代码扫描查询进行过滤(\url{https://github.com/OWNER/REPO/actions/new?category=security&query=code+scanning})：

\myGraphic{0.4}{content/chapter6/images/13.png}{图6.13 --- 向您的存储库添加第三方扫描工具}

您可以探索所有已发布到市场的模板工作流程的合作伙伴。

如果您有其他工具，只要它们支持静态分析结果交换格式(SARIF；请参阅 \url{https://sarifweb.azurewebsites.net/}) - 结构化信息标准推进组织(OASIS)批准的静态代码分析标准 - 作为输出格式，您仍然可以集成它们。

为了给您一个例子，您可以使用 Checkov，这是一个用于基础设施即代码(IaC)的静态代码分析工具，支持 Terraform、Terraform plan、CloudFormation、AWS 无服务器应用程序模型(SAM)、Kubernetes、Helm 图表、Kustomize、Dockerfiles、Serverless、Bicep、OpenAPI 或 ARM 模板。使用 bridgecrewio/checkov-action 操作来运行您的分析，然后将结果上传到 GitHub：

\begin{shell}
- name: Checkov GitHub Action
  uses: bridgecrewio/checkov-action@v12
  with:
    output_format: sarif

- name: Upload SARIF file
  uses: github/codeql-action/upload-sarif@v3
  with:
    sarif_file: results.sarif
  if: always()
\end{shell}

这样，只要它们支持 SARIF，您就可以轻松地集成市场上所有可用的代码扫描工具。












